<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ê¸€ì“°ê¸° ë¹„íŒì  ë¶„ì„ ë° ë…¼ìˆ  í”„ë¡œê·¸ë¨</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° (ê¹”ë”í•œ ë””ìì¸ì„ ìœ„í•´) */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <h1 class="text-4xl font-extrabold text-blue-800 mb-2">ë¹„íŒì  ë¬¸í•´ë ¥ í›ˆë ¨ì†Œ ğŸ“</h1>
        <p class="text-lg text-gray-600 mb-6">AIê°€ ì œì‹œí•œ ê¸€ì˜ ë…¼ë¦¬ ì˜¤ë¥˜ë¥¼ ì°¾ê³ , íƒ€ë‹¹í•œ ê·¼ê±°ë¡œ ìì‹ ì˜ ì£¼ì¥ì„ í¼ì³ë³´ì„¸ìš”. (ì´ˆë“±í•™êµ 6í•™ë…„ ëŒ€ìƒ)</p>
        
        <!-- Firebase ì´ˆê¸°í™” ë° ìƒíƒœ ë©”ì‹œì§€ -->
        <div id="authStatus" class="text-sm p-3 mb-6 rounded-lg bg-yellow-100 text-yellow-800">
            ì¸ì¦ ë° ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘...
        </div>

        <!-- 1ë‹¨ê³„: ì£¼ì œ ì…ë ¥ ë° AI ê¸€ ìƒì„± ìš”ì²­ -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-4 border-blue-500">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">1ë‹¨ê³„: ë…¼ìˆ  ì£¼ì œ ì •í•˜ê¸°</h2>
            <p class="mb-3 text-gray-600">ì•„ë˜ ì£¼ì œê°€ ë¬´ì‘ìœ„ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. **ìƒˆë¡œìš´ ì´ˆì•ˆì„ ìƒì„±**í•˜ë ¤ë©´ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
            <input type="text" id="topicInput" 
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 mb-4 font-semibold text-lg" readonly>
            
            <button id="generateButton" 
                    class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition duration-300 shadow-md disabled:bg-gray-400">
                AI ë…¼ìˆ  ì´ˆì•ˆ ìƒˆë¡œ ìƒì„±í•˜ê¸°
            </button>
        </div>

        <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
        <div id="loadingIndicator" class="hidden text-center p-6 mb-8">
            <div class="flex items-center justify-center space-x-2">
                <div class="w-4 h-4 bg-blue-500 rounded-full animate-pulse"></div>
                <div class="w-4 h-4 bg-blue-500 rounded-full animate-pulse delay-150"></div>
                <div class="w-4 h-4 bg-blue-500 rounded-full animate-pulse delay-300"></div>
                <span class="text-lg font-medium text-gray-700 ml-3">AIê°€ ë…¼ë¦¬ì  ì˜¤ë¥˜ë¥¼ ë„£ê³  ê¸€ì„ ì“°ëŠ” ì¤‘ì…ë‹ˆë‹¤...</span>
            </div>
        </div>

        <!-- 2ë‹¨ê³„: AI ê¸€ ë¹„íŒì  ë¶„ì„ -->
        <div id="analysisSection" class="grid grid-cols-1 lg:grid-cols-2 gap-8 hidden">
            <!-- AI ìƒì„± ì´ˆì•ˆ íŒ¨ë„ -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-red-500">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">ğŸ¤– AI ë…¼ìˆ  ì´ˆì•ˆ (ë¹„íŒì ìœ¼ë¡œ ì½ê¸°)</span>
                </h2>
                <div id="aiEssayOutput" class="p-4 bg-red-50 border border-red-200 rounded-lg min-h-[150px] hide-scrollbar overflow-y-auto text-gray-800 leading-relaxed whitespace-pre-wrap">
                    AIê°€ ìƒì„±í•œ ê¸€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                </div>
                
                <h3 class="text-xl font-semibold mt-6 mb-3 text-red-700">ğŸ“Œ ë°œê²¬í•œ ë…¼ë¦¬ ì˜¤ë¥˜/ì•½í•œ ê·¼ê±°</h3>
                <textarea id="fallacyAnalysis" rows="4" placeholder="AI ê¸€ì—ì„œ ë‹¤ìŒ ì˜¤ë¥˜ë¥¼ ì°¾ì•„ ì ê³ , ì™œ ì˜ëª»ë˜ì—ˆëŠ”ì§€ ì„¤ëª…í•˜ì„¸ìš”: 
1) ì¶œì²˜ ë¶ˆëª…í™•í•œ í†µê³„/ìˆ˜ì¹˜ (ê°€ì§œ ì‚¬ì‹¤)
2) ë…¼ë¦¬ì  ë¹„ì•½/ì˜¤ë¥˜ (ì„±ê¸‰í•œ ì¼ë°˜í™” ë“±)
3) ëª¨í˜¸í•˜ê±°ë‚˜ ê·¼ê±° ì—†ëŠ” ì£¼ì¥ (ê°€ì§œ ë‰´ìŠ¤)"
                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150 mb-4"></textarea>

                <h3 class="text-xl font-semibold mt-4 mb-3 text-green-700">âœ… íŒ©íŠ¸ì²´í¬: ë‚´ê°€ ì°¾ì€ íƒ€ë‹¹í•œ ê·¼ê±°</h3>
                <textarea id="factCheckSources" rows="4" placeholder="AI ê·¼ê±°ë¥¼ ê²€ì¦í•˜ê±°ë‚˜, ì£¼ì œì— ëŒ€í•œ ìƒˆë¡­ê³  ì •í™•í•œ ê·¼ê±°ë¥¼ 2~3ê°€ì§€ ì´ìƒ ì¡°ì‚¬í•˜ì—¬ ì¶œì²˜ì™€ í•¨ê»˜ ê¸°ë¡í•˜ì„¸ìš”."
                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150"></textarea>
            </div>

            <!-- ì‚¬ìš©ì ìµœì¢… ë…¼ìˆ  ì‘ì„± íŒ¨ë„ -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">âœï¸ ë‚˜ì˜ ìµœì¢… ì£¼ì¥í•˜ëŠ” ê¸€ ì‘ì„±</span>
                </h2>
                <p class="text-sm text-gray-500 mb-4">AIì˜ ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•˜ê³ , íŒ©íŠ¸ì²´í¬ë¥¼ ê±°ì¹œ íƒ€ë‹¹í•œ ê·¼ê±°ë§Œì„ ì‚¬ìš©í•˜ì—¬ ë…¼ë¦¬ì ì¸ ì£¼ì¥ ê¸€ì„ ì™„ì„±í•˜ì„¸ìš”.</p>
                <textarea id="finalEssay" rows="18" placeholder="ë‚˜ì˜ ì£¼ì¥í•˜ëŠ” ê¸€ (ì„œë¡ -ë³¸ë¡ -ê²°ë¡ ì˜ êµ¬ì¡°ë¥¼ ê°–ì¶° ì‘ì„±)"
                          class="w-full p-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 min-h-[400px]"></textarea>

                <button id="submitButton" 
                        class="w-full mt-4 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition duration-300 shadow-md">
                    ê¸€ì“°ê¸° ì™„ë£Œ ë° ì„±ì°°í•˜ê¸°
                </button>
            </div>
        </div>
    </div>
    
    <!-- Custom Notification Box (Alert ëŒ€ì²´) -->
    <div id="notificationBox" class="fixed top-5 right-5 z-50 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 opacity-0 pointer-events-none" role="alert">
        <div id="notificationMessage"></div>
    </div>

    <script type="module">
        // Firebase ëª¨ë“ˆ ì„í¬íŠ¸
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore ë¡œê¹… ë ˆë²¨ ì„¤ì • (ë””ë²„ê¹…ìš©)
        setLogLevel('Debug');

        // ì „ì—­ ë³€ìˆ˜ ì„¤ì • (Canvas í™˜ê²½ì—ì„œ ì œê³µë¨)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let isAuthReady = false;
        let isInitialCheckComplete = false; // ì´ˆê¸° ë¡œë“œ ë° ë°ì´í„° í™•ì¸ ì™„ë£Œ í”Œë˜ê·¸

        // UI ìš”ì†Œ
        const authStatus = document.getElementById('authStatus');
        const generateButton = document.getElementById('generateButton');
        const topicInput = document.getElementById('topicInput');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const analysisSection = document.getElementById('analysisSection');
        const aiEssayOutput = document.getElementById('aiEssayOutput');
        const submitButton = document.getElementById('submitButton');
        const fallacyAnalysis = document.getElementById('fallacyAnalysis');
        const factCheckSources = document.getElementById('factCheckSources');
        const finalEssay = document.getElementById('finalEssay');
        const notificationBox = document.getElementById('notificationBox');
        const notificationMessage = document.getElementById('notificationMessage');
        
        // ë¬´ì‘ìœ„ ì£¼ì œ ëª©ë¡ (êµì‚¬ ê´€ë ¨ ì£¼ì œ ì œì™¸)
        const TOPICS = [
            "K-íŒ ë°ëª¬ í—Œí„°ìŠ¤: ì´ˆëŠ¥ë ¥ ì•„ì´ëŒì˜ í•„ìš”ì„±", 
            "í™˜ê²½: ì¼íšŒìš©í’ˆ ì‚¬ìš©ì„ ì¦‰ì‹œ ì „ë©´ ê¸ˆì§€í•´ì•¼ í•œë‹¤", 
            "AI: AIê°€ ë§Œë“œëŠ” ì˜ˆìˆ  ì‘í’ˆì„ ì¸ì •í•´ì•¼ í•˜ëŠ”ê°€?",
            "ë¡œë´‡: ê°€ì •ìš© ë¡œë´‡ì´ ëª¨ë“  ì§‘ì•ˆì¼ì„ ëŒ€ì‹ í•´ì•¼ í•œë‹¤"
        ];
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¬´ì‘ìœ„ ì£¼ì œ ì„¤ì •
        function getRandomTopic() {
            const randomIndex = Math.floor(Math.random() * TOPICS.length);
            return TOPICS[randomIndex];
        }

        // ì´ˆê¸° ì£¼ì œ ì„¤ì • (ì´ì „ì— ì„¤ì •ëœ ê°’ì´ ì—†ìœ¼ë©´ ëœë¤ìœ¼ë¡œ)
        if (!topicInput.value || topicInput.value === 'AIê°€ ìƒì„±í•œ ê¸€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.') {
            topicInput.value = getRandomTopic();
        }


        // Custom Notification Function
        function showNotification(message, type = 'success') {
            notificationMessage.textContent = message;
            // ì´ˆê¸° í´ë˜ìŠ¤ ì •ë¦¬
            notificationBox.classList.remove('opacity-0', 'pointer-events-none', 'bg-red-600', 'bg-blue-600', 'bg-green-600');
            
            // íƒ€ì…ë³„ ìƒ‰ìƒ ì„¤ì •
            if (type === 'success') {
                notificationBox.classList.add('bg-green-600');
            } else if (type === 'error') {
                notificationBox.classList.add('bg-red-600');
            } else { // info (default for non-success/error)
                notificationBox.classList.add('bg-blue-600');
            }

            // í‘œì‹œ
            notificationBox.classList.remove('opacity-0', 'pointer-events-none');
            notificationBox.classList.add('opacity-100');

            // 5ì´ˆ í›„ ì‚¬ë¼ì§
            setTimeout(() => {
                notificationBox.classList.remove('opacity-100');
                notificationBox.classList.add('opacity-0', 'pointer-events-none');
            }, 5000);
        }


        // Firebase ì´ˆê¸°í™” ë° ì¸ì¦
        async function initializeFirebase() {
            if (firebaseConfig) {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // ì¸ì¦ ìƒíƒœ ë³€í™” ë¦¬ìŠ¤ë„ˆ
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            authStatus.textContent = `ì‚¬ìš©ì ID: ${userId} (ì¸ì¦ ì™„ë£Œ)`;
                            authStatus.classList.replace('bg-yellow-100', 'bg-green-100');
                            authStatus.classList.replace('text-yellow-800', 'text-green-800');
                            isAuthReady = true;
                            // ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ë° ìë™ ìƒì„± íŠ¸ë¦¬ê±°
                            loadUserData(userId); 
                        } else {
                            // í† í°ì´ ìˆìœ¼ë©´ ì»¤ìŠ¤í…€ í† í° ë¡œê·¸ì¸, ì—†ìœ¼ë©´ ìµëª… ë¡œê·¸ì¸ ì‹œë„
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                    });
                } catch (error) {
                    console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜:", error);
                    authStatus.textContent = `Firebase ì˜¤ë¥˜: ${error.message}`;
                    authStatus.classList.replace('bg-yellow-100', 'bg-red-100');
                    authStatus.classList.replace('text-yellow-800', 'text-red-800');
                    isAuthReady = true; // ì¸ì¦ì´ ì‹¤íŒ¨í•´ë„ ì•± êµ¬ë™ì€ ì‹œë„
                    loadUserData(crypto.randomUUID()); // ì„ì‹œ IDë¡œ ë°ì´í„° ë¡œë“œ ì‹œë„ (ì‹¤íŒ¨í•  ê°€ëŠ¥ì„± ë†’ìŒ)
                }
            } else {
                authStatus.textContent = 'Firebase ì„¤ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ëŠ¥ì´ ì œí•œë©ë‹ˆë‹¤.';
                isAuthReady = true;
                // Firebaseê°€ ì—†ì„ ê²½ìš°ì—ë„ ìë™ ìƒì„± ë¡œì§ ì‹¤í–‰
                handleInitialGeneration(false); 
            }
        }

        // Firestore ë°ì´í„° ì €ì¥ (ì‚¬ìš©ìê°€ ì‘ì„±í•œ ë¶„ì„ ë° ìµœì¢… ê¸€ ì €ì¥)
        async function saveUserData() {
            if (!db || !userId) return;

            const userRef = doc(db, 'artifacts', appId, 'users', userId, 'critical_essays', 'draft');
            const data = {
                topic: topicInput.value,
                aiDraft: aiEssayOutput.textContent,
                fallacyAnalysis: fallacyAnalysis.value,
                factCheckSources: factCheckSources.value,
                finalEssay: finalEssay.value,
                timestamp: new Date().toISOString()
            };

            try {
                await setDoc(userRef, data);
                console.log("ë°ì´í„° ì €ì¥ ì™„ë£Œ:", data);
            } catch (e) {
                console.error("ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:", e);
                showNotification(`ë°ì´í„° ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
            }
        }

        // Firestore ë°ì´í„° ë¡œë“œ ë° ìë™ ìƒì„± íŠ¸ë¦¬ê±°
        function loadUserData(currentUserId) {
            if (!db) {
                handleInitialGeneration(false); // DB ì—†ìœ¼ë©´ ë°”ë¡œ ìë™ ìƒì„± ì‹œë„
                return;
            }
            const userRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'critical_essays', 'draft');
            
            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            onSnapshot(userRef, (docSnap) => {
                let draftLoaded = false;
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    topicInput.value = data.topic || topicInput.value; 
                    aiEssayOutput.textContent = data.aiDraft || 'AIê°€ ìƒì„±í•œ ê¸€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
                    fallacyAnalysis.value = data.fallacyAnalysis || '';
                    factCheckSources.value = data.factCheckSources || '';
                    finalEssay.value = data.finalEssay || '';
                    
                    if (data.aiDraft && data.aiDraft.trim() !== 'AIê°€ ìƒì„±í•œ ê¸€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.') {
                        analysisSection.classList.remove('hidden');
                        aiEssayOutput.classList.remove('text-gray-500');
                        draftLoaded = true;
                    }
                    console.log("ì´ì „ ë°ì´í„° ë¡œë“œ ì™„ë£Œ.");
                } else {
                    console.log("ì €ì¥ëœ ë°ì´í„° ì—†ìŒ.");
                }

                handleInitialGeneration(draftLoaded);

            }, (error) => {
                console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
                showNotification(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
                handleInitialGeneration(false); // ì—ëŸ¬ ë°œìƒ ì‹œ ìë™ ìƒì„± ì‹œë„
            });
        }
        
        // ì²« ë¡œë“œ ì‹œ ìë™ ìƒì„± ë¡œì§ ì²˜ë¦¬
        function handleInitialGeneration(draftLoaded) {
             if (isInitialCheckComplete) return;

            // ì €ì¥ëœ ì´ˆì•ˆì´ ì—†ê±°ë‚˜ ë¡œë“œì— ì‹¤íŒ¨í–ˆì„ ê²½ìš°ì—ë§Œ ìë™ ìƒì„± ì‹œë„
            if (!draftLoaded) {
                // UI ë Œë”ë§ì„ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ ìƒì„± ì‹œì‘
                setTimeout(() => {
                    if (topicInput.value && generateButton.disabled === false) { 
                        generateAIDraft(topicInput.value);
                    }
                }, 100);
            }
            isInitialCheckComplete = true; // ì´ˆê¸° í™•ì¸ ì™„ë£Œ
        }

        // Gemini API í˜¸ì¶œ í•¨ìˆ˜ (AI ë…¼ìˆ  ì´ˆì•ˆ ìƒì„±)
        async function generateAIDraft(topic) {
            if (!topic.trim()) {
                showNotification('ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // UI ìƒíƒœ ë³€ê²½
            generateButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            analysisSection.classList.add('hidden');
            aiEssayOutput.textContent = '';
            aiEssayOutput.classList.add('text-gray-500');
            fallacyAnalysis.value = '';
            factCheckSources.value = '';
            finalEssay.value = '';

            // ******************************************************
            // API Key ë§¤ê°œë³€ìˆ˜ë¥¼ ì™„ì „íˆ ì œê±°í•˜ê³  í”Œë«í¼ ìë™ ì£¼ì…ì—ë§Œ ì˜ì¡´í•˜ë„ë¡ ìˆ˜ì •
            // ******************************************************
            const MODEL_NAME = "gemini-2.5-flash"; 
            // const apiKey = ""; // API í‚¤ ë³€ìˆ˜ ì œê±°
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`; // ?key=${apiKey} ë¶€ë¶„ ì œê±°

            const systemPromptText = `
                ë‹¹ì‹ ì€ ì´ˆë“±í•™êµ 6í•™ë…„ì„ ìœ„í•œ ê¸€ì“°ê¸° í•™ìŠµì„ ë•ëŠ” AI ë…¼ìˆ  ì‘ì„±ê¸°ì…ë‹ˆë‹¤. 
                ì‚¬ìš©ìê°€ ì œì‹œí•œ ì£¼ì œì— ëŒ€í•´ ì£¼ì¥í•˜ëŠ” ê¸€(ì•½ 250ì ë‚´ì™¸)ì„ ì‘ì„±í•˜ì„¸ìš”.
                í•™ìƒì˜ ë¹„íŒì  ì‚¬ê³  í›ˆë ¨ì„ ìœ„í•´, ê¸€ ë‚´ìš©ì—ëŠ” ë‹¤ìŒ ë‘ ê°€ì§€ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”:
                1. ì¶œì²˜ê°€ ë¶ˆëª…í™•í•˜ê±°ë‚˜ **ê²€ì¦ì´ í•„ìš”í•œ í†µê³„/ìˆ˜ì¹˜** (ê°€ì§œ ì‚¬ì‹¤) 1ê°œ.
                2. ì£¼ì¥ì„ ë’·ë°›ì¹¨í•˜ê¸°ì— ë…¼ë¦¬ì  ì—°ê²°ì´ ë¶€ì¡±í•˜ê±°ë‚˜ **ì„±ê¸‰í•œ ì¼ë°˜í™” ì˜¤ë¥˜**ì— í•´ë‹¹í•˜ëŠ” ê·¼ê±° 1ê°œ. (ë…¼ë¦¬ì  ë¹„ì•½)
                ê¸€ì€ ì„œë¡ -ë³¸ë¡ -ê²°ë¡ ì˜ í˜•ì‹ì„ ê°–ì¶”ê³ , ê·¼ê±°ë“¤ì„ ëª…í™•í•˜ê²Œ êµ¬ë¶„í•  ìˆ˜ ìˆë„ë¡ ì‘ì„±í•˜ì„¸ìš”.
            `;
            
            const userQuery = `ì£¼ì œ: "${topic}"ì— ëŒ€í•œ ì£¼ì¥í•˜ëŠ” ê¸€ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.`;
            
            // í˜ì´ë¡œë“œ êµ¬ì¡° (role: "system"ì„ contents ì•ˆì— í¬í•¨)
            const payload = {
                contents: [
                    { role: "system", parts: [{ text: systemPromptText.trim() }] },
                    { role: "user", parts: [{ text: userQuery }] }
                ]
            };

            // ë””ë²„ê¹…: ì „ì†¡ í˜ì´ë¡œë“œ í™•ì¸
            console.log("--- DEBUG: Gemini API Request ---");
            console.log("Model:", MODEL_NAME);
            console.log("URL:", apiUrl);
            console.log("Payload:", JSON.stringify(payload, null, 2));


            const maxRetries = 5;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API Call Failed (Status: ${response.status})`);
                        console.error("Error Response Body:", errorText);

                        if (response.status === 429 && i < maxRetries - 1) { // 429 Too Many Requests
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential backoff
                            continue;
                        }
                        
                        // 403 ì—ëŸ¬ë¥¼ í¬í•¨í•œ ê¸°íƒ€ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                        const statusMessage = `API í˜¸ì¶œ ì‹¤íŒ¨ (ìƒíƒœ ì½”ë“œ: ${response.status}). ê¶Œí•œ ë˜ëŠ” ìš”ì²­ êµ¬ì¡° ë¬¸ì œì…ë‹ˆë‹¤.`; 
                        aiEssayOutput.textContent = `${statusMessage}\n\nìì„¸í•œ ì˜¤ë¥˜: ${errorText.substring(0, 200)}...`;
                        showNotification(statusMessage, 'error');
                        break; 
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        aiEssayOutput.textContent = text.trim();
                        analysisSection.classList.remove('hidden');
                        aiEssayOutput.classList.remove('text-gray-500');
                        saveUserData();
                        showNotification('AI ì´ˆì•ˆì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë¹„íŒì ìœ¼ë¡œ ë¶„ì„í•´ ë³´ì„¸ìš”.', 'info');
                        break; // ì„±ê³µ ì‹œ ë£¨í”„ ì¢…ë£Œ
                    } else {
                        // í…ìŠ¤íŠ¸ê°€ ì—†ê±°ë‚˜ êµ¬ì¡°ê°€ ì´ìƒí•  ê²½ìš°
                        aiEssayOutput.textContent = 'ê¸€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”. (ì‘ë‹µ ë‚´ìš© ì—†ìŒ)';
                        showNotification('ê¸€ ìƒì„± ì‹¤íŒ¨ (ì‘ë‹µ ë¬¸ì œ)', 'error');
                        break;
                    }

                } catch (error) {
                    console.error("Gemini API í˜¸ì¶œ ì¤‘ JavaScript ì˜¤ë¥˜:", error);
                    aiEssayOutput.textContent = `ê¸€ ìƒì„± ì¤‘ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
                    showNotification(`ê¸€ ìƒì„± ë‚´ë¶€ ì˜¤ë¥˜: ${error.message}`, 'error');
                    if (i === maxRetries - 1) {
                        console.error("ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼.");
                    } else {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }
            }
            
            // UI ìƒíƒœ ë³µì›
            generateButton.disabled = false;
            loadingIndicator.classList.add('hidden');
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        generateButton.addEventListener('click', () => {
            // ìƒˆ ì´ˆì•ˆ ìƒì„± ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìƒˆë¡œìš´ ì£¼ì œë¡œ ë³€ê²½ í›„ ìƒì„± ì‹œì‘
            topicInput.value = getRandomTopic(); 
            generateAIDraft(topicInput.value);
        });

        submitButton.addEventListener('click', () => {
            if (finalEssay.value.trim().length < 50) {
                showNotification('ìµœì¢… ì£¼ì¥ ê¸€ì„ 50ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            saveUserData();
            showNotification('ê¸€ì“°ê¸° í™œë™ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! AI ì˜¤ë¥˜ë¥¼ ë¶„ì„í•˜ê³  íƒ€ë‹¹í•œ ê·¼ê±°ë¥¼ ì‚¬ìš©í•˜ì—¬ í›Œë¥­í•œ ì£¼ì¥ ê¸€ì„ ì™„ì„±í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì£¼ì œë¡œ ë‹¤ì‹œ í›ˆë ¨í•´ ë³´ì„¸ìš”.', 'success');
        });
        
        // ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ìë™ ì €ì¥
        [topicInput, fallacyAnalysis, factCheckSources, finalEssay].forEach(element => {
            element.addEventListener('input', saveUserData);
        });

        // ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
        initializeFirebase();

        // í…ìŠ¤íŠ¸ ì˜ì—­ ë†’ì´ ìë™ ì¡°ì ˆ (ë¯¸ê´€ìƒ)
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        [fallacyAnalysis, factCheckSources, finalEssay].forEach(element => {
            element.addEventListener('input', () => autoResizeTextarea(element));
        });

    </script>
</body>
</html>